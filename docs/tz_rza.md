# Техническое задание на разработку приложения РЗА

## 1. Общие сведения
- **Наименование системы:** Приложение РЗА ЭЗОИС-СПб
- **Назначение:** автоматизация проектирования, конфигурирования и сопровождения шкафов РЗА 6–110 кВ по ГОСТ 34.602.
- **Стек:** FastAPI, Pydantic, SQLAlchemy (SQLite), AsyncIO.

## 2. Функциональные требования
### 2.1 Подсистема управления объектами
- CRUD для ПС, РУ и ячеек.
- Связность: ПС → РУ → Ячейки → Шкафы.
- Валидация уникальности кодов ПС.

### 2.2 Подсистема шкафов и устройств
- Учёт шкафов РЗА с атрибутами (назначение, тип, статус, примечания).
- Регистр устройств, включая производителя, модель, версию ПО и признак основного устройства.
- Статусы шкафов: draft, engineering, produced, commissioned.

### 2.3 Подсистема конфигураций
- Версионность DeviceConfig по устройствам.
- История SettingRevision с признаком активной уставки.
- Возможность активации ревизии с автоматическим закрытием предыдущей.

### 2.4 Подсистема отчётности
- Сводные показатели по объектам/устройствам.
- Дерево структуры по выбранной ПС.
- История конфигураций устройства.

### 2.5 Документооборот
- Учёт прикрепленных документов (ТЗ, схемы, отчёты) с хранением ссылки и контрольной суммы.

## 3. Нефункциональные требования
- Асинхронный API (async/await).
- Логирование аудита по критичным операциям (создание/изменение/удаление объектов, конфигураций, ревизий).
- Возможность конфигурации через переменные окружения (`Settings`).
- OpenAPI документация доступна по `/docs`.

## 4. Интерфейсы API
- `/objects/*` — управление ПС, РУ, ячейками.
- `/panels/*` — управление шкафами и устройствами.
- `/configs/*` — управление конфигурациями и уставками.
- `/reports/*` — отчёты и аналитика.
- `/health` — мониторинг.

## 5. Структура данных
- **Substation**: id, name, code, voltage_class, location, description.
- **Switchgear**: FK на ПС, тип, класс напряжения.
- **Bay**: FK на РУ, назначение, feeder.
- **RzaPanel**: FK на ячейку, тип, статус.
- **RzaDevice**: FK на шкаф, vendor/model, firmware_version, is_primary.
- **DeviceConfig**: FK на устройство, version_tag, status, payload.
- **SettingRevision**: FK на конфигурацию, revision, settings, флажки активности, даты.
- **Document**: FK на ПС, doc_type, имя, URI, checksum.
- **AuditLog**: action, entity, actor, before/after state.

## 6. Требования к аудиту
- Ведение журнала `AuditLog` при: создании/обновлении/удалении ПС, РУ, ячеек, шкафов, устройств, конфигураций и ревизий.
- Фиксация пользователя (`actor`), состояния до и после операции, времени события.

## 7. Требования к отчётности
- Сводные показатели должны формироваться одним SQL-запросом на агрегаты.
- История конфигураций включает список DeviceConfig и SettingRevision.

## 8. Ввод в эксплуатацию
- Развёртывание с помощью `uvicorn app.main:app --reload`.
- Инициализация БД выполняется автоматически при старте (`init_db`).
- База данных по умолчанию — `rza.db` в корне проекта.

## 9. Требования к документации
- Техническое задание (`docs/tz_rza.md`).
- Маппинг функций (`docs/functions_mapping.md`).

## 10. Требования к качеству
- Полное покрытие бизнес-объектов схемами Pydantic.
- Type hints во всех модулях.
- Комментарии на русском языке.
